name: "üåå GalaxyRDP Ultra by VayVy ‚Äî Cleaned"

on:
  workflow_dispatch:

jobs:
  vayvy-rdp:
    runs-on: windows-latest
    timeout-minutes: 720 # 12 jam

    env:
      # ---------------------------
      # EDIT THESE (strongly recommended to use GitHub Secrets)
      # ---------------------------
      # Discord webhook: move to secrets (recommended: secrets.DISCORD_WEBHOOK)
      DISCORD_WEBHOOK: "PASTE_YOUR_DISCORD_WEBHOOK_HERE"

      # Tailscale auth key: recommended to use secrets.TAILSCALE_AUTH_KEY
      USE_INLINE_TAILSCALE_KEY: "false"
      INLINE_TAILSCALE_AUTH_KEY: ""

      # Owner / user & password (for convenience here; better to use secrets)
      RDP_USER: "Vayvy"
      RDP_PASSWORD: "Vay2025!"

      # Cosmetic / keepalive / artifacts
      KEEP_ALIVE_MINUTES: "720"        # 12 hours
      KEEP_ALIVE_INTERVAL_SECS: "300"  # heartbeat every 5 minutes
      ARTIFACT_DIR: "galaxyrdp-artifacts"
      WALLPAPER_WIDTH: "1920"
      WALLPAPER_HEIGHT: "1080"
      WALLPAPER_PATH: "$env:PUBLIC\\Vayvy_galaxyrdp_wallpaper.jpg"
      TAILSCALE_VERSION: "1.82.0"
      RDP_PORT: "3389"

    steps:
      - name: "üì• Checkout (optional assets)"
        uses: actions/checkout@v4

      - name: "üß∞ Prepare artifact folder"
        shell: pwsh
        run: |
          $d = "$env:ARTIFACT_DIR"
          if (-not (Test-Path $d)) { New-Item -Path $d -ItemType Directory | Out-Null }
          Write-Host "Artifact dir: $d"

      - name: "‚ú® Intro Banner ‚Äî GalaxyRDP Ultra"
        shell: pwsh
        run: |
          Write-Host ""
          Write-Host ("‚ïê" * 80) -ForegroundColor Cyan
          Write-Host "üåå GalaxyRDP Ultra by VayVy ‚Äî Professional Provisioning & Keep-Alive" -ForegroundColor Green
          Write-Host "Repository : $env:GITHUB_REPOSITORY" -ForegroundColor Cyan
          Write-Host "Run ID     : $env:GITHUB_RUN_ID" -ForegroundColor Cyan
          Write-Host "Actor      : $env:GITHUB_ACTOR" -ForegroundColor Cyan
          Write-Host "Start Time : $(Get-Date -Format o)" -ForegroundColor Cyan
          Write-Host ("‚ïê" * 80) -ForegroundColor Cyan
          Write-Host ""

      - name: "üõ°Ô∏è Ensure Admin Privileges (best-effort check)"
        shell: pwsh
        run: |
          try {
            $isAdmin = (New-Object Security.Principal.WindowsPrincipal([Security.Principal.WindowsIdentity]::GetCurrent())).IsInRole([Security.Principal.WindowsBuiltInRole]::Administrator)
            if (-not $isAdmin) {
              Write-Host "‚ö†Ô∏è Warning: Runner may not be elevated. Some operations may fail." -ForegroundColor Yellow
            } else {
              Write-Host "‚úÖ Running with administrative privileges." -ForegroundColor Green
            }
          } catch {
            Write-Host "‚ö†Ô∏è Failed to determine elevation: $_" -ForegroundColor Yellow
          }

      - name: "‚öôÔ∏è Configure core RDP settings (enable, NLA opt, firewall)"
        shell: pwsh
        run: |
          $log="$env:ARTIFACT_DIR\01-config-rdp.log"
          try {
            Write-Host "----- RDP CONFIGURATION -----" -ForegroundColor Cyan

            # Enable RDP
            Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server' -Name "fDenyTSConnections" -Value 0 -Force
            Write-Host "üîì RDP enabled (fDenyTSConnections=0)" -ForegroundColor Green

            # Optionally set NLA off for broader compatibility
            Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server\WinStations\RDP-Tcp' -Name "UserAuthentication" -Value 0 -Force
            Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server\WinStations\RDP-Tcp' -Name "SecurityLayer" -Value 0 -Force
            Write-Host "üîß RDP WinStation params set (UserAuthentication=0, SecurityLayer=0)" -ForegroundColor Green

            # Firewall: idempotent rule for RDP port
            $ruleName = "GalaxyRDP-Allowed-3389"
            & netsh advfirewall firewall delete rule name="$ruleName" 2>$null
            netsh advfirewall firewall add rule name="$ruleName" dir=in action=allow protocol=TCP localport=$env:RDP_PORT profile=any | Out-Null
            Write-Host "üõ°Ô∏è Firewall rule added: $ruleName on port $env:RDP_PORT" -ForegroundColor Green

            # Restart TermService to apply
            Restart-Service -Name TermService -Force -ErrorAction SilentlyContinue
            Start-Sleep -Seconds 3
            Write-Host "üîÅ TermService restarted" -ForegroundColor Green

            "OK" | Out-File -FilePath $log -Append
          } catch {
            $_ | Out-String | Out-File -FilePath $log -Append
            Write-Host "‚ùå RDP configuration failed: $($_.Exception.Message)" -ForegroundColor Red
            exit 1
          }

      - name: "üë§ Create local RDP user (Vayvy) ‚Äî password fixed"
        shell: pwsh
        run: |
          $log="$env:ARTIFACT_DIR\02-create-user.log"
          try {
            Write-Host "----- CREATE RDP USER -----" -ForegroundColor Magenta
            $user = $env:RDP_USER
            $pass = $env:RDP_PASSWORD

            # If user exists, remove then create for idempotency
            if (Get-LocalUser -Name $user -ErrorAction SilentlyContinue) {
              Write-Host "‚ôªÔ∏è Removing existing user $user" -ForegroundColor Yellow
              Remove-LocalUser -Name $user -ErrorAction SilentlyContinue
            }

            $secure = ConvertTo-SecureString $pass -AsPlainText -Force
            New-LocalUser -Name $user -Password $secure -AccountNeverExpires -PasswordNeverExpires -UserMayNotChangePassword:$false -ErrorAction Stop

            # Add to groups
            Add-LocalGroupMember -Group "Administrators" -Member $user -ErrorAction SilentlyContinue
            Add-LocalGroupMember -Group "Remote Desktop Users" -Member $user -ErrorAction SilentlyContinue

            # Save credentials to artifact (user must delete after download)
            $credFile = "$env:ARTIFACT_DIR\creds.txt"
            "USER:$user`nPASSWORD:$pass`nNOTE: Remove this file after secure retrieval." | Out-File -FilePath $credFile -Encoding UTF8

            Write-Host "üîê User $user created and added to groups; credentials stored in artifact ($credFile)." -ForegroundColor Green
            "OK" | Out-File -FilePath $log -Append
          } catch {
            $_ | Out-String | Out-File -FilePath $log -Append
            Write-Host "‚ùå User creation failed: $($_.Exception.Message)" -ForegroundColor Red
            exit 1
          }

      - name: "üé® Generate & apply premium wallpaper"
        shell: pwsh
        run: |
          $log="$env:ARTIFACT_DIR\03-wallpaper.log"
          try {
            Add-Type -AssemblyName System.Drawing

            $width = [int]$env:WALLPAPER_WIDTH
            $height = [int]$env:WALLPAPER_HEIGHT
            $bmp = New-Object Drawing.Bitmap $width, $height
            $gfx = [Drawing.Graphics]::FromImage($bmp)

            # Background gradient
            $rect = New-Object Drawing.Rectangle 0,0,$width,$height
            $brush = New-Object Drawing.Drawing2D.LinearGradientBrush $rect,
              [Drawing.Color]::FromArgb(30,30,60),
              [Drawing.Color]::FromArgb(10,10,20),
              [Drawing.Drawing2D.LinearGradientMode]::ForwardDiagonal
            $gfx.FillRectangle($brush, $rect)

            # Fonts
            $fontCenter = New-Object Drawing.Font("Segoe UI", 52, [Drawing.FontStyle]::Bold)
            $fontBottom = New-Object Drawing.Font("Segoe UI", 16, [Drawing.FontStyle]::Italic)

            # Brushes
            $whiteBrush = [Drawing.Brushes]::White
            $grayBrush  = [Drawing.Brushes]::LightGray

            # Center watermark
            $text = "RDP by Vayvy"
            $size = $gfx.MeasureString($text, $fontCenter)
            $gfx.DrawString($text, $fontCenter, $whiteBrush, ($width - $size.Width)/2, ($height - $size.Height)/2)

            # Footer copyright
            $footer = "Copyright ¬© Vayvy"
            $size2 = $gfx.MeasureString($footer, $fontBottom)
            $gfx.DrawString($footer, $fontBottom, $grayBrush, $width - $size2.Width - 20, $height - $size2.Height - 20)

            # Save wallpaper
            $output = $env:WALLPAPER_PATH
            $bmp.Save($output, [Drawing.Imaging.ImageFormat]::Jpeg)

            # Apply wallpaper (SystemParametersInfo)
            Add-Type @"
using System.Runtime.InteropServices;
public class Win32 {
  [DllImport("user32.dll", SetLastError=true)]
  public static extern bool SystemParametersInfo(int uAction, int uParam, string lpvParam, int fuWinIni);
}
"@
            [Win32]::SystemParametersInfo(20,0,$output,3) | Out-Null

            "Wallpaper generated: $output" | Out-File -FilePath $log -Append
            Write-Host "‚úÖ Wallpaper applied: $output" -ForegroundColor Green
          } catch {
            $_ | Out-String | Out-File -FilePath $log -Append
            Write-Host "‚ö†Ô∏è Wallpaper generation failed: $($_.Exception.Message)" -ForegroundColor Yellow
          }

      - name: "üåê Install Tailscale (versioned, idempotent)"
        shell: pwsh
        run: |
          $log="$env:ARTIFACT_DIR\04-install-tailscale.log"
          try {
            Write-Host "----- INSTALL TAILSCALE -----" -ForegroundColor Cyan
            $tsExe = Join-Path $env:ProgramFiles "Tailscale\tailscale.exe"
            if (Test-Path $tsExe) {
              Write-Host "‚úÖ Tailscale already installed at $tsExe" -ForegroundColor Green
            } else {
              $ver = $env:TAILSCALE_VERSION
              $msi = Join-Path $env:TEMP "tailscale-$ver.msi"
              $url = "https://pkgs.tailscale.com/stable/tailscale-setup-$ver-amd64.msi"
              Write-Host "‚¨áÔ∏è Downloading $url ..." -ForegroundColor Cyan
              Invoke-WebRequest -Uri $url -OutFile $msi -UseBasicParsing -ErrorAction Stop
              Start-Process msiexec.exe -ArgumentList "/i", "`"$msi`"", "/quiet", "/norestart" -Wait -ErrorAction Stop
              Remove-Item $msi -Force -ErrorAction SilentlyContinue
              Write-Host "‚úÖ Tailscale installed." -ForegroundColor Green
            }
            "OK" | Out-File -FilePath $log -Append
          } catch {
            $_ | Out-String | Out-File -FilePath $log -Append
            Write-Host "‚ùå Tailscale install failed: $($_.Exception.Message)" -ForegroundColor Red
            exit 1
          }

      - name: "üîó Establish Tailscale connection (authkey handling & IP detection)"
        shell: pwsh
        env:
          # Prefer using secret: secrets.TAILSCALE_AUTH_KEY
          TAILSCALE_AUTH_KEY: ${{ secrets.TAILSCALE_AUTH_KEY }}
        run: |
          $log = "$env:ARTIFACT_DIR\05-tailscale-up.log"
          try {
            Write-Host "----- TAILSCALE UP -----" -ForegroundColor Cyan
            $tsExe = Join-Path $env:ProgramFiles "Tailscale\tailscale.exe"
            if (-not (Test-Path $tsExe)) { $tsExe = Join-Path ($env:ProgramFiles + " (x86)") "Tailscale\tailscale.exe" }
            if (-not (Test-Path $tsExe)) { throw "tailscale.exe not found" }

            $hostname = "gh-runner-$($env:GITHUB_RUN_ID)"
            $auth = $env:TAILSCALE_AUTH_KEY
            if ($auth -and $auth -ne "") {
              Write-Host "Using secret-provided TAILSCALE_AUTH_KEY" -ForegroundColor Cyan
              & $tsExe up --authkey=$auth --hostname=$hostname | Out-File -FilePath $log -Append
            } elseif ($env:USE_INLINE_TAILSCALE_KEY -eq "true" -and $env:INLINE_TAILSCALE_AUTH_KEY) {
              Write-Host "Using inline tailscale key (INSECURE) as requested" -ForegroundColor Yellow
              & $tsExe up --authkey=$env:INLINE_TAILSCALE_AUTH_KEY --hostname=$hostname | Out-File -FilePath $log -Append
            } else {
              Write-Host "‚ö†Ô∏è No Tailscale auth key provided. Attempting up without key (will likely fail)." -ForegroundColor Yellow
              & $tsExe up --hostname=$hostname | Out-File -FilePath $log -Append
            }

            # Wait for IP assignment w/ retries
            $tsIP = $null; $r=0
            while (-not $tsIP -and $r -lt 18) {
              Start-Sleep -Seconds 5
              $raw = & $tsExe ip -4 2>$null
              if ($raw) { $tsIP = ($raw -split "`n" | Where-Object { $_ -match '\\d+\\.\\d+\\.\\d+\\.\\d+' }) -join ',' }
              $r++
            }

            if (-not $tsIP) {
              try { $tsIP = (Invoke-RestMethod -Uri "https://ifconfig.me/ip" -TimeoutSec 8) } catch { $tsIP = "Unknown" }
            }

            Write-Host "üåç Tailscale/Public IP: $tsIP" -ForegroundColor Green
            Add-Content -Path $env:GITHUB_ENV -Value "TS_IP=$tsIP"
            "TS_IP=$tsIP" | Out-File -FilePath $log -Append

            # Ensure RDP allowed on any interface (redundant with earlier rule)
            try {
              New-NetFirewallRule -DisplayName "GalaxyRDP-Allow-3389" -Direction Inbound -Protocol TCP -LocalPort $env:RDP_PORT -Action Allow -Profile Any -ErrorAction SilentlyContinue
            } catch {}

          } catch {
            $_ | Out-String | Out-File -FilePath $log -Append
            Write-Host "‚ùå Tailscale up failed: $($_.Exception.Message)" -ForegroundColor Red
            exit 1
          }

      - name: "üîç Verify RDP reachability (via Tailscale IP or local)"
        shell: pwsh
        run: |
          $log="$env:ARTIFACT_DIR\06-verify-rdp.log"
          try {
            Write-Host "----- VERIFY RDP -----" -ForegroundColor Cyan
            $ips = @()
            if ($env:TS_IP -and $env:TS_IP -ne "Unknown") {
              $ips = $env:TS_IP -split ','
            } else {
              # fallback: localhost
              $ips = @("127.0.0.1")
            }
            $ok = $false
            foreach ($ip in $ips) {
              $ip = $ip.Trim()
              Write-Host "Testing TCP $ip:$env:RDP_PORT ..." -NoNewline
              $t = Test-NetConnection -ComputerName $ip -Port $env:RDP_PORT -WarningAction SilentlyContinue
              if ($t.TcpTestSucceeded) {
                Write-Host " ‚úÖ" -ForegroundColor Green
                $ok = $true
                break
              } else {
                Write-Host " ‚ùå (TcpTestSucceeded=$($t.TcpTestSucceeded))" -ForegroundColor Yellow
              }
            }
            if (-not $ok) { throw "No reachable RDP endpoint on known IPs" }
            "OK" | Out-File -FilePath $log -Append
          } catch {
            $_ | Out-String | Out-File -FilePath $log -Append
            Write-Host "‚ùå RDP verification failed: $($_.Exception.Message)" -ForegroundColor Red
            exit 1
          }

      - name: "üì° Network & System Snapshot (monitoring)"
        shell: pwsh
        run: |
          $outFile = "$env:ARTIFACT_DIR\07-monitoring.json"
          try {
            Write-Host "----- MONITORING SNAPSHOT -----" -ForegroundColor Cyan
            $os = Get-CimInstance Win32_OperatingSystem | Select-Object Caption, Version, BuildNumber, LastBootUpTime
            $cpu = (Get-Counter '\\Processor(_Total)\\% Processor Time').CounterSamples.CookedValue
            $memTotalMB = [math]::Round((Get-CimInstance Win32_ComputerSystem).TotalPhysicalMemory / 1MB,2)
            $memFreeMB = [math]::Round((Get-Counter '\\Memory\\Available MBytes').CounterSamples.CookedValue,2)
            $disks = Get-PSDrive -PSProvider FileSystem | Select-Object Name, @{n='FreeGB';e={[math]::Round($_.Free/1GB,2)}}
            $tails = ""
            try { $tails = (& "$env:ProgramFiles\Tailscale\tailscale.exe" status 2>$null) } catch {}
            $obj = [pscustomobject]@{
              Timestamp = (Get-Date).ToUniversalTime().ToString("o")
              Computer = $env:COMPUTERNAME
              OS = $os
              CPUPercent = [math]::Round($cpu,2)
              Memory = @{ TotalMB=$memTotalMB; FreeMB=$memFreeMB }
              Disks = $disks
              Tailscale = $tails
            }
            $obj | ConvertTo-Json -Depth 8 | Out-File -FilePath $outFile -Encoding UTF8
            Write-Host "‚úÖ Monitoring snapshot: $outFile" -ForegroundColor Green
          } catch {
            Write-Host "‚ö†Ô∏è Monitoring failed: $($_.Exception.Message)" -ForegroundColor Yellow
          }

      - name: "üîî Discord ‚Äî Notify START (includes IP, NOT password yet)"
        shell: pwsh
        run: |
          $log = "$env:ARTIFACT_DIR\08-discord-start.log"
          try {
            $hook = $env:DISCORD_WEBHOOK
            if (-not $hook -or $hook -eq "PASTE_YOUR_DISCORD_WEBHOOK_HERE") {
              Write-Host "‚ö†Ô∏è Discord webhook not configured (env DISCORD_WEBHOOK). Skipping Discord start notify." -ForegroundColor Yellow
              exit 0
            }

            $run = $env:GITHUB_RUN_ID
            $actor = $env:GITHUB_ACTOR
            $repo = $env:GITHUB_REPOSITORY
            $tsip = $env:TS_IP
            try { $public = Invoke-RestMethod -Uri "https://ifconfig.me/ip" -TimeoutSec 6 } catch { $public = "Unknown" }

            $embed = @{
              title = "üöÄ GalaxyRDP Ultra ‚Äî Provisioning Started"
              description = "Preparing RDP, user, Tailscale, wallpaper, and keep-alive."
              color = 5814783
              fields = @(
                @{ name = "üë§ Actor"; value = $actor; inline = $true },
                @{ name = "üì¶ Repo";  value = $repo; inline = $true },
                @{ name = "üîÅ Run ID"; value = $run; inline = $true },
                @{ name = "üåê Public IP"; value = $public; inline = $true },
                @{ name = "üîó Candidate IP (Tailscale)"; value = ($tsip ? $tsip : "Pending"); inline = $true }
              )
              footer = @{ text = "GalaxyRDP Ultra ‚Ä¢ $(Get-Date -Format o)" }
            }

            $payload = @{ username = "GalaxyRDP Bot"; embeds = @($embed) } | ConvertTo-Json -Depth 8
            Invoke-RestMethod -Uri $hook -Method Post -Body $payload -ContentType 'application/json' -ErrorAction Stop
            Write-Host "‚úÖ Discord start notification posted." -ForegroundColor Green
            "OK" | Out-File -FilePath $log -Append
          } catch {
            $_ | Out-String | Out-File -FilePath $log -Append
            Write-Host "‚ö†Ô∏è Discord start notify failed: $($_.Exception.Message)" -ForegroundColor Yellow
          }

      - name: "‚è≥ Keep-Alive Loop (12h) ‚Äî background job + alert thresholds"
        shell: pwsh
        run: |
          $log = "$env:ARTIFACT_DIR\09-keepalive.log"
          try {
            Write-Host "----- START KEEP-ALIVE (background) -----" -ForegroundColor Cyan

            $interval = [int]$env:KEEP_ALIVE_INTERVAL_SECS
            $limitMinutes = [int]$env:KEEP_ALIVE_MINUTES

            $script = {
              param($envvars)
              $hook = $envvars.DISCORD_WEBHOOK
              $user = $envvars.RDP_USER
              $pass = $envvars.RDP_PASSWORD
              $interval = [int]$envvars.KEEP_ALIVE_INTERVAL_SECS
              $keepMinutes = [int]$envvars.KEEP_ALIVE_MINUTES

              for ($elapsed = 0; $elapsed -lt ($keepMinutes * 60); $elapsed += $interval) {
                try {
                  $cpu = (Get-Counter '\\Processor(_Total)\\% Processor Time').CounterSamples.CookedValue
                  $memFree = (Get-Counter '\\Memory\\Available MBytes').CounterSamples.CookedValue
                  $line = "[Heartbeat] $(Get-Date -Format o) | CPU: $([math]::Round($cpu,2))% | FreeMB: $([math]::Round($memFree,2))"
                  $line | Out-File -FilePath "$envvars.ARTIFACT_DIR\heartbeat.log" -Append

                  # Send lightweight alert if CPU > 90 or memory very low
                  if ($cpu -gt 90 -or $memFree -lt 200) {
                    if ($hook -and $hook -ne "PASTE_YOUR_DISCORD_WEBHOOK_HERE") {
                      $embed = @{
                        title = "‚ö†Ô∏è GalaxyRDP Alert ‚Äî High Resource Usage"
                        description = "Resource threshold crossed on run $($envvars.GITHUB_RUN_ID)"
                        color = 15548997
                        fields = @(
                          @{ name = "CPU %"; value = "$([math]::Round($cpu,2))"; inline = $true },
                          @{ name = "Free MB"; value = "$([math]::Round($memFree,2))"; inline = $true }
                        )
                        footer = @{ text = "Auto-alert from GalaxyRDP" }
                      }
                      $payload = @{ username="GalaxyRDP Bot"; embeds=@($embed) } | ConvertTo-Json -Depth 6
                      try { Invoke-RestMethod -Uri $hook -Method Post -ContentType "application/json" -Body $payload -ErrorAction SilentlyContinue } catch {}
                    }
                  }
                } catch {}
                Start-Sleep -Seconds $interval
              }
            }

            # Pass limited envvars to job
            $ev = @{
              DISCORD_WEBHOOK = $env:DISCORD_WEBHOOK;
              RDP_USER = $env:RDP_USER;
              RDP_PASSWORD = $env:RDP_PASSWORD;
              KEEP_ALIVE_INTERVAL_SECS = $env:KEEP_ALIVE_INTERVAL_SECS;
              KEEP_ALIVE_MINUTES = [int]$env:KEEP_ALIVE_MINUTES;
              ARTIFACT_DIR = $env:ARTIFACT_DIR;
              GITHUB_RUN_ID = $env:GITHUB_RUN_ID
            }

            Start-Job -ScriptBlock $script -ArgumentList ($ev) | Out-Null
            Write-Host "‚úÖ Keep-alive background job started (will run for $env:KEEP_ALIVE_MINUTES minutes)." -ForegroundColor Green
            "OK" | Out-File -FilePath $log -Append
          } catch {
            $_ | Out-String | Out-File -FilePath $log -Append
            Write-Host "‚ö†Ô∏è Keep-alive job failed to start: $($_.Exception.Message)" -ForegroundColor Yellow
          }

      - name: "üîî Discord ‚Äî Notify SUCCESS (includes Tailscale IP & RDP credentials)"
        if: success()
        shell: pwsh
        run: |
          $log="$env:ARTIFACT_DIR\10-discord-success.log"
          try {
            $hook = $env:DISCORD_WEBHOOK
            if (-not $hook -or $hook -eq "PASTE_YOUR_DISCORD_WEBHOOK_HERE") {
              Write-Host "‚ÑπÔ∏è Discord webhook not configured; skipping success notify." -ForegroundColor Yellow
              exit 0
            }

            # Capture IPs (Tailscale or public fallback)
            $ts = $env:TS_IP
            if (-not $ts -or $ts -eq "") {
              try { $ts = Invoke-RestMethod -Uri "https://ifconfig.me/ip" -TimeoutSec 6 } catch { $ts = "Unknown" }
            }

            $embed = @{
              title = "‚úÖ GalaxyRDP Ultra ‚Äî Session Ready"
              description = "RDP is provisioned and reachable. Credentials included below ‚Äî handle with care."
              color = 5763719
              fields = @(
                @{ name = "üë§ User"; value = $env:RDP_USER; inline = $true },
                @{ name = "üîë Password"; value = $env:RDP_PASSWORD; inline = $true },
                @{ name = "üîó Tailscale / Effective IP"; value = ($ts -ne "" ? $ts : "Unknown"); inline = $true },
                @{ name = "üîå RDP Port"; value = $env:RDP_PORT; inline = $true },
                @{ name = "üïí Keep-Alive (mins)"; value = $env:KEEP_ALIVE_MINUTES; inline = $true }
              )
              footer = @{ text = "GalaxyRDP Ultra ‚Ä¢ $(Get-Date -Format 'yyyy-MM-dd HH:mm:ss')" }
            }

            $payload = @{ username = "GalaxyRDP Bot"; embeds = @($embed) } | ConvertTo-Json -Depth 8
            Invoke-RestMethod -Uri $hook -Method Post -Body $payload -ContentType 'application/json' -ErrorAction Stop
            Write-Host "‚úÖ Discord success notification sent (contains credentials as requested)." -ForegroundColor Green
            "OK" | Out-File -FilePath $log -Append
          } catch {
            $_ | Out-String | Out-File -FilePath $log -Append
            Write-Host "‚ö†Ô∏è Discord success notify failed: $($_.Exception.Message)" -ForegroundColor Yellow
          }

      - name: "üì¶ Upload artifacts (logs & creds) ‚Äî download & delete after retrieval"
        uses: actions/upload-artifact@v4
        with:
          name: galaxyrdp-artifacts-${{ github.run_id }}
          path: ${{ env.ARTIFACT_DIR }}

      - name: "üßπ Best-effort cleanup local credential copy"
        shell: pwsh
        run: |
          try {
            $cf = "$env:ARTIFACT_DIR\creds.txt"
            if (Test-Path $cf) {
              "REDACTED - removed by workflow" | Out-File -FilePath $cf -Encoding UTF8
              Remove-Item -Path $cf -Force -ErrorAction SilentlyContinue
              Write-Host "üßπ Local creds file removed from runner (artifact copy may still exist)." -ForegroundColor Green
            }
          } catch {
            Write-Host "‚ö†Ô∏è Cleanup creds failed: $($_.Exception.Message)" -ForegroundColor Yellow
          }

      - name: "üèÅ Finish Banner"
        shell: pwsh
        run: |
          Write-Host ""
          Write-Host ("‚ïê" * 80) -ForegroundColor Cyan
          Write-Host "üèÅ GalaxyRDP Ultra ‚Äî Provisioning Completed (or kept alive for duration)" -ForegroundColor Green
          Write-Host "Run ID: $env:GITHUB_RUN_ID  ‚Ä¢  Actor: $env:GITHUB_ACTOR" -ForegroundColor Cyan
          Write-Host ("‚ïê" * 80) -ForegroundColor Cyan
          Write-Host ""

      - name: "‚ùå Discord Failure Notification (if any step failed)"
        if: failure()
        shell: pwsh
        run: |
          try {
            $hook = $env:DISCORD_WEBHOOK
            if (-not $hook -or $hook -eq "PASTE_YOUR_DISCORD_WEBHOOK_HERE") { exit 0 }
            $actor = $env:GITHUB_ACTOR
            $run = $env:GITHUB_RUN_ID
            $err = if ($Error.Count -gt 0) { $Error[0].ToString() } else { "Unknown error ‚Äî check logs" }
            if ($err.Length -gt 500) { $err = $err.Substring(0,500) + "..." }
            $embed = @{
              title = "‚ùå GalaxyRDP Ultra ‚Äî Workflow Failed"
              description = "One or more steps failed. Please review artifacts & logs."
              color = 15548997
              fields = @(
                @{ name = "üë§ Actor"; value = $actor; inline = $true },
                @{ name = "üîÅ Run ID"; value = $run; inline = $true },
                @{ name = "üõë Error (short)"; value = $err; inline = $false }
              )
              footer = @{ text = "GalaxyRDP Ultra ‚Ä¢ $(Get-Date -Format 'yyyy-MM-dd HH:mm:ss')" }
            }
            $payload = @{ username="GalaxyRDP Bot"; embeds=@($embed) } | ConvertTo-Json -Depth 6
            Invoke-RestMethod -Uri $hook -Method Post -Body $payload -ContentType "application/json" -ErrorAction Stop
            Write-Host "‚úÖ Failure notification sent to Discord." -ForegroundColor Yellow
          } catch {
            Write-Host "‚ö†Ô∏è Failed to send failure notification: $($_.Exception.Message)" -ForegroundColor Yellow
          }
