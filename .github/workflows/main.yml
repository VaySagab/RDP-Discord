name: 🌌 GalaxyRDP Ultra by VayVy [12h Keep-Alive | Discord Integrated]

# ===================================================================
# GalaxyRDP Ultra - Longform Workflow (Hybrid)
# - Initial functional steps (Enable RDP, Create User, Install & Connect Tailscale)
#   use Yanzz-style implementation (functionality preserved)
# - All text/banner/Discord/wallpaper/monitoring/keep-alive remain Vayvy style
# ===================================================================

on:
  workflow_dispatch:

jobs:
  vayvy-rdp:
    runs-on: windows-latest
    timeout-minutes: 720   # 12 jam

    env:
      # ----------------------------------------------------------------
      # DO NOT CHANGE: Discord webhook as requested by user.
      # If you want to move this to secrets, consider using:
      #   DISCORD_WEBHOOK: ${{ secrets.DISCORD_WEBHOOK }}
      # ----------------------------------------------------------------
      DISCORD_WEBHOOK: "https://discord.com/api/webhooks/1421078099763789845/u1bE8nK9wIBfMR1pii65HsQqb28BfcF65VMaLzurUGtIoaKeYg1Eb67gLG9aLdWCJ0MM"

      # ----------------------------------------------------------------
      # Keep alive configuration
      # ----------------------------------------------------------------
      KEEP_ALIVE_MINUTES: 720

      # ----------------------------------------------------------------
      # Misc defaults (documented)
      # ----------------------------------------------------------------
      EMULATOR_BOOT_WAIT_SECONDS: 90
      EMULATOR_POLL_RETRIES: 6
      DOWNLOAD_TRIES: 4
      MIN_VALID_BYTES: 2000000   # 2MB basic sanity

    steps:

      # =================================================================
      # Intro / Banner (visual) — Vayvy style
      # =================================================================
      - name: ✨ Intro Job metadata & friendly banner
        shell: pwsh
        run: |
          Write-Host ""
          Write-Host "════════════════════════════════════════════════════════════════════════" -ForegroundColor Cyan
          Write-Host "🌌 GalaxyRDP Ultra - PRO Mode (Verbose Logging, Monitoring, Discord)" -ForegroundColor Green
          Write-Host "Repository : $env:GITHUB_REPOSITORY" -ForegroundColor Cyan
          Write-Host "Run ID     : $env:GITHUB_RUN_ID" -ForegroundColor Cyan
          Write-Host "Actor      : $env:GITHUB_ACTOR" -ForegroundColor Cyan
          Write-Host "Start Time : $(Get-Date -Format o)" -ForegroundColor Cyan
          Write-Host "════════════════════════════════════════════════════════════════════════" -ForegroundColor Cyan
          Write-Host ""

      # =================================================================
      # Step 1 - Enable RDP (Yanzz function, Vayvy style text)
      # =================================================================
      - name: ⚙️ Enable RDP
        shell: pwsh
        run: |
          Write-Host ""
          Write-Host "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━" -ForegroundColor Cyan
          Write-Host "⚙️ Enabling Remote Desktop Protocol (RDP) — (Yanzz function)" -ForegroundColor Green
          Write-Host "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━" -ForegroundColor Cyan

          # Yanzz-style functional commands (unchanged logic)
          Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server' `
            -Name "fDenyTSConnections" -Value 0 -Force
          Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server\WinStations\RDP-Tcp' `
            -Name "UserAuthentication" -Value 0 -Force
          Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server\WinStations\RDP-Tcp' `
            -Name "SecurityLayer" -Value 0 -Force

          netsh advfirewall firewall delete rule name="RDP-Tailscale" | Out-Null
          netsh advfirewall firewall add rule name="RDP-Tailscale" dir=in action=allow protocol=TCP localport=3389 | Out-Null

          Restart-Service -Name TermService -Force -ErrorAction SilentlyContinue

          Write-Host "✅ RDP enable commands executed (Yanzz function)." -ForegroundColor Yellow
          Write-Host "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━" -ForegroundColor Cyan
          Write-Host ""

      # =================================================================
      # Step 2 - Create RDP User (Yanzz function, username set to Vayvy)
      # =================================================================
      - name: 👤 Create RDP user (Vayvy)
        shell: pwsh
        run: |
          Write-Host "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
          Write-Host "👤 Creating RDP User 'Vayvy' — fixed password mode" -ForegroundColor Green
          Write-Host "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"

          $password = "Vaygtg2025"
          $securePass = ConvertTo-SecureString $password -AsPlainText -Force

          # Create or update user Vayvy
          if (-not (Get-LocalUser -Name "Vayvy" -ErrorAction SilentlyContinue)) {
            New-LocalUser -Name "Vayvy" -Password $securePass -AccountNeverExpires
            Write-Host "✅ User 'Vayvy' created." -ForegroundColor Yellow
          } else {
            Set-LocalUser -Name "Vayvy" -Password $securePass
            Write-Host "✅ User 'Vayvy' updated." -ForegroundColor Yellow
          }

          Add-LocalGroupMember -Group "Administrators" -Member "Vayvy" -ErrorAction SilentlyContinue
          Add-LocalGroupMember -Group "Remote Desktop Users" -Member "Vayvy" -ErrorAction SilentlyContinue

          echo "RDP_USER=Vayvy" >> $env:GITHUB_ENV
          echo "RDP_PASS=$password" >> $env:GITHUB_ENV

          Write-Host "🎉 RDP user ready: Vayvy | Password: $password" -ForegroundColor Green
          Write-Host "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"


      # =================================================================
      # STEP: Generate Custom Text Wallpaper (Vayvy feature — preserved)
      # =================================================================
      - name: 🖼️ Generate Custom Text Wallpaper 
        shell: pwsh
        run: |
          Write-Host ""
          Write-Host "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━" -ForegroundColor Cyan
          Write-Host "🖼️ Generating Custom Wallpaper (Vayvy watermark & footer)" -ForegroundColor Green
          Write-Host "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━" -ForegroundColor Cyan
          try {
            Add-Type -AssemblyName System.Drawing
            $width = 1920; $height = 1080
            $bmp = New-Object System.Drawing.Bitmap $width, $height
            $g = [System.Drawing.Graphics]::FromImage($bmp)
            $g.SmoothingMode = [System.Drawing.Drawing2D.SmoothingMode]::HighQuality
            $g.Clear([System.Drawing.Color]::Black)

            # Main text in center
            $mainText = "🌌 GalaxyRDP Ultra by VayVy 🚀"
            $fontMain = New-Object System.Drawing.Font("Consolas", 72, [System.Drawing.FontStyle]::Bold, [System.Drawing.GraphicsUnit]::Pixel)
            $brushMain = New-Object System.Drawing.SolidBrush([System.Drawing.Color]::Lime)
            $size = $g.MeasureString($mainText, $fontMain)
            $x = ($width - $size.Width) / 2
            $y = ($height - $size.Height) / 2
            $g.DrawString($mainText, $fontMain, $brushMain, $x, $y)

            # Watermark (top-right)
            $wmText = "$($env:GITHUB_REPOSITORY) | Run $($env:GITHUB_RUN_ID) | $($env:GITHUB_ACTOR)"
            $wmFont = New-Object System.Drawing.Font("Arial", 18, [System.Drawing.FontStyle]::Regular, [System.Drawing.GraphicsUnit]::Pixel)
            $wmSize = $g.MeasureString($wmText, $wmFont)
            $wmX = $width - $wmSize.Width - 20
            $wmY = 20
            $g.DrawString($wmText, $wmFont, [System.Drawing.Brushes]::Gray, $wmX, $wmY)

            # Footer (bottom-right)
            $footer = "⚡ Powered by GitHub Actions"
            $footerFont = New-Object System.Drawing.Font("Arial", 18, [System.Drawing.FontStyle]::Regular, [System.Drawing.GraphicsUnit]::Pixel)
            $footerSize = $g.MeasureString($footer, $footerFont)
            $fx = $width - $footerSize.Width - 20
            $fy = $height - $footerSize.Height - 20
            $g.DrawString($footer, $footerFont, [System.Drawing.Brushes]::DarkGray, $fx, $fy)

            # Save and apply
            $outPath = "$env:USERPROFILE\Pictures\galaxyrdp-wallpaper.jpg"
            $bmp.Save($outPath, [System.Drawing.Imaging.ImageFormat]::Jpeg)
            Set-ItemProperty -Path "HKCU:\Control Panel\Desktop" -Name Wallpaper -Value $outPath
            rundll32.exe user32.dll, UpdatePerUserSystemParameters

            Write-Host "✅ Wallpaper applied successfully (with dynamic watermark & footer)." -ForegroundColor Yellow
          } catch {
            Write-Host "⚠️ Wallpaper generation failed: $_" -ForegroundColor Red
          }
          Write-Host "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━" -ForegroundColor Cyan
          Write-Host ""

      # =================================================================
      # Step 3 - Install Tailscale (Yanzz function — preserved)
      # =================================================================
      - name: 🌐 Install Tailscale
        shell: pwsh
        run: |
          Write-Host ""
          Write-Host "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━" -ForegroundColor Cyan
          Write-Host "🌐 Installing Tailscale (Yanzz installer function)" -ForegroundColor Green
          Write-Host "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━" -ForegroundColor Cyan

          $installer = "$env:TEMP\tailscale.msi"
          Invoke-WebRequest -Uri "https://pkgs.tailscale.com/stable/tailscale-setup-1.82.0-amd64.msi" -OutFile $installer -UseBasicParsing -ErrorAction Stop
          Start-Process msiexec.exe -ArgumentList "/i", "`"$installer`"", "/quiet", "/norestart" -Wait -ErrorAction Stop
          Remove-Item $installer -Force -ErrorAction SilentlyContinue

          Write-Host "✅ Tailscale installer executed (Yanzz function)." -ForegroundColor Yellow
          Write-Host "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━" -ForegroundColor Cyan
          Write-Host ""

      # =================================================================
      # Step 4 - Connect to Tailscale (Yanzz function — preserved)
      # =================================================================
      - name: 🔗 Connect to Tailscale
        shell: pwsh
        env:
          TAILSCALE_AUTH_KEY: ${{ secrets.TAILSCALE_AUTH_KEY }}
        run: |
          Write-Host ""
          Write-Host "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━" -ForegroundColor Cyan
          Write-Host "🔗 Connecting to Tailscale Network (Yanzz function)" -ForegroundColor Green
          Write-Host "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━" -ForegroundColor Cyan

          $tsExe = (Get-Command tailscale.exe -ErrorAction SilentlyContinue)?.Source
          if (-not $tsExe) {
            $candidates = @("$env:ProgramFiles\Tailscale\tailscale.exe","$env:ProgramFiles(x86)\Tailscale\tailscale.exe")
            foreach ($p in $candidates) { if (Test-Path $p) { $tsExe = $p; break } }
          }

          if ($tsExe) {
            try {
              & $tsExe up --authkey=$env:VAYVY_TAILSCALE_AUTHKEY --hostname "GalaxyRDP-${env:GITHUB_RUN_ID}" --accept-routes
              $tsIP = $null; $retries = 0
              while (-not $tsIP -and $retries -lt 12) {
                Start-Sleep -Seconds 5
                $out = & $tsExe ip -4 2>$null
                if ($out) { $tsIP = ($out | Where-Object { $_ -match '^\d+\.\d+\.\d+\.\d+$' } | Select-Object -First 1) }
                $retries++
              }
              if ($tsIP) {
                Add-Content -Path $env:GITHUB_ENV -Value "TS_IP=$tsIP"
                Write-Host "🌍 Tailscale IP: $tsIP" -ForegroundColor Yellow
                # Allow RDP over Tailscale
                New-NetFirewallRule -DisplayName "RDP over Tailscale" -Direction Inbound -Protocol TCP -LocalPort 3389 -Action Allow -Profile Any -InterfaceAlias "Tailscale*" -ErrorAction SilentlyContinue
              } else {
                Add-Content -Path $env:GITHUB_ENV -Value "TS_IP=Unknown"
                Write-Host "⚠️ Tailscale connected but IP not found." -ForegroundColor Yellow
              }
            } catch {
              Add-Content -Path $env:GITHUB_ENV -Value "TS_IP=Unknown"
              Write-Host "⚠️ Tailscale up failed: $_" -ForegroundColor Yellow
            }
          } else {
            Add-Content -Path $env:GITHUB_ENV -Value "TS_IP=Unknown"
            Write-Host "⚠️ tailscale.exe not found; skipping connect." -ForegroundColor Yellow
          }

          Write-Host "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━" -ForegroundColor Cyan
          Write-Host ""

      # =================================================================
      # Step 5 - System tweaks (safe & non-destructive) — Vayvy features
      # =================================================================
      - name: ⚡ Optimize Windows for RDP
        shell: pwsh
        run: |
          Write-Host ""
          Write-Host "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━" -ForegroundColor Cyan
          Write-Host "⚡ Optimizing Windows (Safe Tweaks)" -ForegroundColor Green
          Write-Host "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━" -ForegroundColor Cyan
          try {
            # Visual FX → Best Performance
            reg add "HKCU\Software\Microsoft\Windows\CurrentVersion\Explorer\VisualEffects" /v VisualFXSetting /t REG_DWORD /d 2 /f | Out-Null

            # Disable unnecessary services safely
            $services = @("WSearch","SysMain","Spooler","Fax","DiagTrack","wuauserv","BthHFSrv")
            foreach ($svc in $services) {
              try {
                Stop-Service -Name $svc -Force -ErrorAction SilentlyContinue
                Set-Service -Name $svc -StartupType Disabled -ErrorAction SilentlyContinue
                Write-Host "⛔ Disabled service: $svc" -ForegroundColor Red
              } catch {
                Write-Host "⚠️ Skip service (not found): $svc" -ForegroundColor Yellow
              }
            }

            # Remove Xbox & OneDrive apps (safe)
            try {
              Get-AppxPackage *xbox* -ErrorAction SilentlyContinue | Remove-AppxPackage -ErrorAction SilentlyContinue
              Get-AppxPackage *OneDrive* -ErrorAction SilentlyContinue | Remove-AppxPackage -ErrorAction SilentlyContinue
              Write-Host "🧹 Removed Xbox & OneDrive apps." -ForegroundColor Magenta
            } catch {
              Write-Host "⚠️ Skipped Xbox/OneDrive removal (not critical)." -ForegroundColor Yellow
            }

            Write-Host "✅ System optimization applied (safe & fast)." -ForegroundColor Yellow
          } catch {
            Write-Host "⚠️ Some optimization steps failed: $_" -ForegroundColor Red
          }
          Write-Host "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━" -ForegroundColor Cyan
          Write-Host ""

      # =================================================================
      # Step 6 - Network & Resource snapshot (Vayvy)
      # =================================================================
      - name: 📡 Check Latency & Health
        shell: pwsh
        run: |
          Write-Host ""
          Write-Host "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━" -ForegroundColor Cyan
          Write-Host "📡 Network latency & basic health snapshot" -ForegroundColor Green
          Write-Host "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━" -ForegroundColor Cyan

          try {
            $target = if ($env:VAYVY_TAILSCALE_IP -and $env:VAYVY_TAILSCALE_IP -ne 'Unknown') { $env:VAYVY_TAILSCALE_IP } else { '8.8.8.8' }
            Write-Host "↔️ Pinging $target ..."
            Test-Connection -ComputerName $target -Count 4 -ErrorAction SilentlyContinue | Format-Table
          } catch {
            Write-Host "⚠️ Ping test failed: $_" -ForegroundColor Yellow
          }

          try {
            $cpu = Get-CimInstance -ClassName Win32_Processor | Select-Object -ExpandProperty LoadPercentage -ErrorAction SilentlyContinue
            $mem = Get-CimInstance -ClassName Win32_OperatingSystem | ForEach-Object { [math]::Round((($_.TotalVisibleMemorySize - $_.FreePhysicalMemory)/$_.TotalVisibleMemorySize)*100,2) }
            Write-Host "📊 CPU Load: $cpu% | Memory Usage: $mem%" -ForegroundColor Yellow
          } catch {
            Write-Host "⚠️ Resource snapshot failed: $_" -ForegroundColor Yellow
          }

          Write-Host "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━" -ForegroundColor Cyan
          Write-Host ""

      # =================================================================
      # Discord Notification: Start (Vayvy)
      # =================================================================
      - name: 🔔 Discord Notification (Start)
        shell: pwsh
        run: |
          Write-Host ""
          Write-Host "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━" -ForegroundColor Cyan
          Write-Host "🔔 [NOTIFY] Sending Discord start notification" -ForegroundColor Green
          Write-Host "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━" -ForegroundColor Cyan

          $rdpUser = $env:RDP_USER
          $rdpPass = $env:RDP_PASS
          $actor   = $env:GITHUB_ACTOR
          $runId   = $env:GITHUB_RUN_ID
          $repo    = $env:GITHUB_REPOSITORY
          $tsIP    = $env:TS_IP

          try { $publicIp = (Invoke-RestMethod -Uri "https://ifconfig.me/ip" -TimeoutSec 10) } catch { $publicIp = "Unknown" }
          try { $tailscaleIp = (tailscale ip -4 | Select-Object -First 1) } catch { $tailscaleIp = "Not Connected" }

          $embed = @{
            title = "🚀 GalaxyRDP Ultra — Session Created"
            description = "Your RDP session is live and ready to use. 🌌"
            color = 11730954
            fields = @(
              @{ name = "👤 GitHub User";   value = "$actor";   inline = $true },
              @{ name = "🖥️ RDP User";     value = "$rdpUser"; inline = $true },
              @{ name = "🔑 RDP Password"; value = "$rdpPass"; inline = $true },
              @{ name = "🌍 Public IP";    value = "$publicIp"; inline = $true },
              @{ name = "🔗 Tailscale IP"; value = "$tsIP"; inline = $true },
              @{ name = "📦 Repository";   value = "$repo"; inline = $false },
              @{ name = "⚙️ Run ID";       value = "$runId"; inline = $false }
            )
            footer = @{
              text = "RDP by VayVy | IG : Vay.Test • $(Get-Date -Format 'yyyy-MM-dd HH:mm:ss')"
            }
          }

          $payload = @{ embeds = @($embed) } | ConvertTo-Json -Depth 10 -Compress
          try {
            Invoke-RestMethod -Uri $env:DISCORD_WEBHOOK -Method Post -ContentType "application/json" -Body $payload -ErrorAction Stop
            Write-Host "✅ Start notification sent to Discord." -ForegroundColor Yellow
          } catch {
            Write-Host "⚠️ Failed to send start notification: $_" -ForegroundColor Yellow
          }
          Write-Host "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━" -ForegroundColor Cyan
          Write-Host ""

      # =================================================================
      # Keep-Alive + Resource Auto Alert (12h) — Vayvy full feature
      # =================================================================
      - name: ⏳ Keep Alive 12h + Resource Auto Alert
        shell: pwsh
        run: |
          Write-Host ""
          Write-Host "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━" -ForegroundColor Cyan
          Write-Host "⏳ Starting keep-alive loop (12h) in background with resource alerts" -ForegroundColor Green
          Write-Host "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━" -ForegroundColor Cyan

          $script = {
            for ($i=0; $i -lt 720; $i++) { # 720 menit = 12 jam
              try {
                $cpu = (Get-Counter '\Processor(_Total)\% Processor Time').CounterSamples.CookedValue
                $ram = (Get-Counter '\Memory\% Committed Bytes In Use').CounterSamples.CookedValue
                $disk = (Get-PSDrive C).Free
                Write-Output "[Keep-Alive] $(Get-Date -Format o) | CPU: {0:N2}%% | RAM: {1:N2}%% | C Free: $disk" -f $cpu, $ram
              } catch {
                Write-Output "[Keep-Alive] ⚠️ Resource check failed: $_"
              }
              Start-Sleep -Seconds 60
            }
          }

          # Run loop in background (non-blocking)
          Start-Job -ScriptBlock $script | Out-Null

          Write-Host "✅ Keep-alive background job started. Workflow will continue." -ForegroundColor Yellow
          Write-Host "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━" -ForegroundColor Cyan
          Write-Host ""

      # =================================================================
      # Monitoring Report generation (report-only) — Vayvy
      # =================================================================
      - name: 🛡️ Monitoring (report-only) - produce file
        shell: pwsh
        continue-on-error: true
        run: |
          Write-Host ""
          Write-Host "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━" -ForegroundColor Cyan
          Write-Host "🛡️ Monitoring (report-only) - snapshotting status" -ForegroundColor Green
          Write-Host "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━" -ForegroundColor Cyan

          $report = [ordered]@{}
          $timestamp = (Get-Date).ToString("o")
          $report["Timestamp"] = $timestamp
          $report["Runner"] = $env:RUNNER_NAME
          $report["GitHubActor"] = $env:GITHUB_ACTOR

          try {
            $ts = Get-Service -Name TermService -ErrorAction Stop
            $report["RDP_Service"] = $ts.Status
          } catch {
            $report["RDP_Service"] = "NotFound"
          }

          try {
            $emuProc = Get-Process -Name MuMuPlayer -ErrorAction SilentlyContinue | Select-Object -First 1
            if ($null -ne $emuProc) {
              $report["Emulator_Process"] = "Running"
              $report["Emulator_PID"] = $emuProc.Id
            } else {
              $report["Emulator_Process"] = "NotRunning"
            }
          } catch {
            $report["Emulator_Process"] = "NotRunning"
          }

          try {
            $adb = $env:ADB_PATH
            if ($adb -and (Test-Path $adb)) {
              $devices = & $adb devices 2>$null
              $report["ADB_Devices"] = ($devices -join "`n")
            } else {
              $report["ADB_Devices"] = "ADB not installed"
            }
          } catch {
            $report["ADB_Devices"] = "Error"
          }

          try {
            $cpu = Get-CimInstance -ClassName Win32_Processor | Select-Object -ExpandProperty LoadPercentage -ErrorAction SilentlyContinue
            $memPercent = Get-CimInstance -ClassName Win32_OperatingSystem | ForEach-Object { [math]::Round((($_.TotalVisibleMemorySize - $_.FreePhysicalMemory)/$_.TotalVisibleMemorySize)*100,2) }
            $diskFree = (Get-PSDrive -Name C -ErrorAction SilentlyContinue).Free
            $report["CPU"] = "$cpu%"
            $report["Memory"] = "$memPercent%"
            $report["C_Drive_Free_Bytes"] = $diskFree
          } catch {
            $report["SystemStats"] = "Unavailable"
          }

          $reportFile = "$env:TEMP\galaxyrdp_monitor_$($env:GITHUB_RUN_ID).txt"
          $sb = New-Object System.Text.StringBuilder
          $report.GetEnumerator() | ForEach-Object { [void]$sb.AppendLine("$($_.Key): $($_.Value)") }
          $sb.ToString() | Out-File -FilePath $reportFile -Encoding utf8

          Write-Host "📋 Monitoring report saved: $reportFile" -ForegroundColor Yellow
          Write-Host "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━" -ForegroundColor Cyan
          Write-Host ""

      # =================================================================
      # Discord Notification: Success (Vayvy)
      # =================================================================
      - name: ✅ Discord Notification (Success)
        if: success()
        shell: pwsh
        run: |
          Write-Host ""
          Write-Host "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━" -ForegroundColor Cyan
          Write-Host "✅ [NOTIFY] Sending Discord success notification" -ForegroundColor Green
          Write-Host "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━" -ForegroundColor Cyan

          $actor = $env:GITHUB_ACTOR
          $repo  = $env:GITHUB_REPOSITORY
          $runId = $env:GITHUB_RUN_ID

          $embed = @{
            title = "✅ GalaxyRDP Ultra — Session Finished (Success)"
            description = "The workflow has completed successfully. 🎉"
            color = 5763719
            fields = @(
              @{ name = "👤 GitHub User"; value = "$actor"; inline = $true },
              @{ name = "📦 Repository"; value = "$repo"; inline = $true },
              @{ name = "⚙️ Run ID";     value = "$runId"; inline = $true }
            )
            footer = @{
              text = "RDP by VayVy | IG : Vay.Test • $(Get-Date -Format 'yyyy-MM-dd HH:mm:ss')"
            }
          }

          $payload = @{ embeds = @($embed) } | ConvertTo-Json -Depth 10 -Compress
          try {
            Invoke-RestMethod -Uri $env:DISCORD_WEBHOOK -Method Post -ContentType "application/json" -Body $payload -ErrorAction Stop
            Write-Host "✅ Success notification sent to Discord." -ForegroundColor Yellow
          } catch {
            Write-Host "⚠️ Failed to send success notification: $_" -ForegroundColor Yellow
          }
          Write-Host "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━" -ForegroundColor Cyan
          Write-Host ""

      # =================================================================
      # Discord Notification: Failure (Vayvy)
      # =================================================================
      - name: ❌ Discord Notification (Failure)
        if: failure()
        shell: pwsh
        run: |
          Write-Host ""
          Write-Host "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━" -ForegroundColor Cyan
          Write-Host "❌ [NOTIFY] Sending Discord failure notification" -ForegroundColor Red
          Write-Host "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━" -ForegroundColor Cyan

          $actor = $env:GITHUB_ACTOR
          $repo  = $env:GITHUB_REPOSITORY
          $runId = $env:GITHUB_RUN_ID

          # Ambil error terakhir
          $lastError = if ($Error.Count -gt 0) { $Error[0].ToString() } else { "No error details captured." }

          $embed = @{
            title = "❌ GalaxyRDP Ultra — Session Failed"
            description = "The workflow has failed. Please check logs. ⚠️"
            color = 15548997
            fields = @(
              @{ name = "👤 GitHub User"; value = "$actor"; inline = $true },
              @{ name = "📦 Repository"; value = "$repo"; inline = $true },
              @{ name = "⚙️ Run ID";     value = "$runId"; inline = $true },
              @{ name = "🛑 Error";      value = "```$lastError```"; inline = $false }
            )
            footer = @{
              text = "RDP by VayVy | IG : Vay.Test • $(Get-Date -Format 'yyyy-MM-dd HH:mm:ss')"
            }
          }

          $payload = @{ embeds = @($embed) } | ConvertTo-Json -Depth 10 -Compress
          try {
            Invoke-RestMethod -Uri $env:DISCORD_WEBHOOK -Method Post -ContentType "application/json" -Body $payload -ErrorAction Stop
            Write-Host "❌ Failure notification sent to Discord." -ForegroundColor Yellow
          } catch {
            Write-Host "⚠️ Failed to send failure notification: $_" -ForegroundColor Yellow
          }
          Write-Host "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━" -ForegroundColor Cyan
          Write-Host ""

      # =================================================================
      # Cleanup (end-of-job best-effort cleanup) & Final Banner (Vayvy)
      # =================================================================
      - name: 🏁 Finish / Summary Banner
        shell: pwsh
        run: |
          Write-Host ""
          Write-Host "════════════════════════════════════════════════════════════════════════" -ForegroundColor Cyan
          Write-Host "🏁 GalaxyRDP Ultra - Run Complete (or kept alive for duration)" -ForegroundColor Green
          Write-Host "Run ID: $env:GITHUB_RUN_ID  •  Actor: $env:GITHUB_ACTOR" -ForegroundColor Cyan
          Write-Host "For details, check Actions run logs & Discord notification." -ForegroundColor Cyan
          Write-Host "════════════════════════════════════════════════════════════════════════" -ForegroundColor Cyan
          Write-Host ""
